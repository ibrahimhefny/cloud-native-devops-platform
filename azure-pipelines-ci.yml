trigger:
- main

pool:
  name: self-hosted-linux

variables:
  IMAGE_NAME: ibrahimhefny/voting-app
  SONAR_HOST_URL: 'http://your-sonarqube-server:9000'  # Update this
  SONAR_TOKEN: $(SONAR_TOKEN)  # Store token as secret variable

stages:
- stage: CI
  displayName: Continuous Integration
  jobs:
  - job: BuildAndScan
    displayName: Sonar + Build + Push
    steps:

    - checkout: self

    # ======================
    # 1️⃣ Run SonarQube Scanner via CLI
    # ======================
    - script: |
        # Download sonar-scanner if not present
        if [ ! -d "sonar-scanner" ]; then
          wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-linux.zip
          unzip sonar-scanner-cli-4.8.0.2856-linux.zip
          mv sonar-scanner-4.8.0.2856-linux sonar-scanner
        fi
        
        # Run analysis
        ./sonar-scanner/bin/sonar-scanner \
          -Dsonar.projectKey=voting-app \
          -Dsonar.projectName=voting-app \
          -Dsonar.sources=. \
          -Dsonar.host.url=$(SONAR_HOST_URL) \
          -Dsonar.login=$(SONAR_TOKEN)
      displayName: 'SonarQube Analysis'
      workingDirectory: $(Build.SourcesDirectory)

    # ======================
    # 2️⃣ Build & Push Docker
    # ======================
    - task: Docker@2
      displayName: Build and Push Image
      inputs:
        command: buildAndPush
        repository: $(IMAGE_NAME)
        dockerfile: '**/Dockerfile'
        containerRegistry: 'dockerhub-connection'
        tags: |
          latest