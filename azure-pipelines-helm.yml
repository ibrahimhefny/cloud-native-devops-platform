trigger: none

resources:
  pipelines:
  - pipeline: terraform
    source: ibrahimhefny.cloud-native-devops-platform
    trigger:
      branches:
        include:
        - main

parameters:
- name: environment
  displayName: 'Environment'
  type: string
  default: nonprod
  values:
  - nonprod
  - prod

variables:
- group: aws-credentials

- name: helmRelease
  value: my-app

- name: helmNamespace
  value: my-app

pool:
  vmImage: ubuntu-latest

stages:

# =========================
# Stage: Helm Deploy
# =========================
- stage: HelmDeploy
  displayName: 'Helm Deploy'
  jobs:
  - job: deploy
    displayName: 'Deploy to EKS using Helm'
    steps:

    # 1️⃣ Install Helm
    - script: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      displayName: 'Install Helm'

    # 2️⃣ Download EKS info from Terraform pipeline
    - download: terraform
      artifact: eks-info
      displayName: 'Download EKS info'

    # 3️⃣ Configure kubeconfig dynamically
    - script: |
        CLUSTER_NAME=$(cat $(Pipeline.Workspace)/eks-info/cluster_name.txt)
        REGION=$(cat $(Pipeline.Workspace)/eks-info/region.txt)

        echo "Using cluster: $CLUSTER_NAME"
        echo "Using region: $REGION"

        aws eks update-kubeconfig \
          --name $CLUSTER_NAME \
          --region $REGION
      displayName: 'Configure kubeconfig'
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

    # 4️⃣ Helm deploy
    - script: |
        helm upgrade --install $(helmRelease) ./helm/my-app \
          --namespace $(helmNamespace) \
          --create-namespace \
          -f ./helm/my-app/values-${{ parameters.environment }}.yaml
      displayName: 'Helm Deploy'
