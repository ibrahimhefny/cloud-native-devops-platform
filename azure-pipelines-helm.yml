trigger: none

resources:
  pipelines:
  - pipeline: terraformInfra
    source: terraform-infra          
    trigger:
      branches:
        include:
        - main

parameters:
- name: environment
  displayName: 'Environment'
  type: string
  default: nonprod
  values:
  - nonprod
  - prod

variables:
- group: aws-credentials

- name: clusterName
  value: '${{ parameters.environment }}-eks'

- name: awsRegion
  value: $(AWS_DEFAULT_REGION)

- name: helmRelease
  value: my-app

- name: helmNamespace
  value: my-app

pool:
  vmImage: ubuntu-latest

stages:

# =========================
# Stage: Helm Deploy
# =========================
- stage: HelmDeploy
  displayName: 'Helm Deploy'
  jobs:
  - job: deploy
    steps:

    - script: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      displayName: 'Install Helm'

    - script: |
        aws eks update-kubeconfig \
          --name $(clusterName) \
          --region $(awsRegion)
      displayName: 'Configure kubeconfig'
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

    - script: |
        helm upgrade --install $(helmRelease) ./helm/my-app \
          --namespace $(helmNamespace) \
          --create-namespace \
          -f ./helm/my-app/values-${{ parameters.environment }}.yaml
      displayName: 'Helm Deploy'
