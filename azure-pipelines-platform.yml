trigger: none

pool:
  vmImage: ubuntu-latest

variables:
  AWS_REGION: us-east-1
  CLUSTER_NAME: nonprod-eks

stages:
- stage: Platform
  jobs:
  - job: InstallPlatform
    steps:

    - script: |
        aws --version
      displayName: Verify AWS CLI

    - script: |
        export AWS_ACCESS_KEY_ID=$(AWS_ACCESS_KEY_ID)
        export AWS_SECRET_ACCESS_KEY=$(AWS_SECRET_ACCESS_KEY)
        export AWS_DEFAULT_REGION=$(AWS_REGION)

        aws eks update-kubeconfig --region $(AWS_REGION) --name $(CLUSTER_NAME)
      displayName: Configure EKS Access

    - script: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      displayName: Install Helm

    - script: |
        helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
        helm repo update
        helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
          --namespace ingress-nginx \
          --create-namespace
      displayName: Install Ingress Controller

    - script: |
        kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
        kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
        kubectl wait --for=condition=available deployment/argocd-server \
          -n argocd --timeout=300s
      displayName: Install ArgoCD