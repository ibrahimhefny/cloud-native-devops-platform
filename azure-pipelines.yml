trigger:
- none

parameters:
- name: action
  displayName: Terraform Action
  type: string
  default: apply
  values:
  - apply
  - destroy

- name: environment
  displayName: Environment
  type: string
  default: nonprod
  values:
  - nonprod
  - prod

variables:
  tfvarsFile: '${{ parameters.environment }}.tfvars'

pool:
  name: self-hosted-linux

stages:

# =========================
# Stage 0: SonarQube Analysis
# =========================
- stage: SonarQubeAnalysis
  displayName: SonarQube Code Analysis
  jobs:
  - job: sonar_scan
    displayName: Run Sonar Scanner
    steps:

    - script: |
        sudo apt update
        sudo apt install unzip -y
        wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
        unzip sonar-scanner-cli-*.zip
        sudo mv sonar-scanner-*/ /opt/sonar-scanner
        export PATH=$PATH:/opt/sonar-scanner/bin
      displayName: Install Sonar Scanner

    - script: |
        export PATH=$PATH:/opt/sonar-scanner/bin
        sonar-scanner \
          -Dsonar.projectKey=hello-app \
          -Dsonar.sources=. \
          -Dsonar.host.url=http://localhost:9000 \
          -Dsonar.login=$(SONAR_TOKEN)
      displayName: Run Sonar Scan


# =========================
# Stage 1: Init & Plan
# =========================
- stage: InitAndPlan
  displayName: Terraform Init & Plan
  jobs:
  - job: terraform_plan
    variables:
    - group: aws-credentials
    steps:

    - script: terraform version
      displayName: Check Terraform

    - script: |
        cd terraform
        terraform init -input=false
      displayName: Terraform Init
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

    - script: |
        cd terraform
        terraform validate
      displayName: Terraform Validate

    - script: |
        cd terraform
        terraform plan -var-file=$(tfvarsFile) -out=tfplan
      displayName: Terraform Plan
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

    - publish: terraform/tfplan
      artifact: terraform-plan

# =========================
# Stage 2: Apply
# =========================
- stage: Apply
  displayName: Terraform Apply
  dependsOn: InitAndPlan
  condition: and(succeeded(), eq('${{ parameters.action }}', 'apply'))
  jobs:
  - job: terraform_apply
    variables:
    - group: aws-credentials
    steps:

    - download: current
      artifact: terraform-plan

    - script: |
        cd terraform
        terraform init -reconfigure
      displayName: Terraform Init (Apply)
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

    - script: |
        cd terraform
        terraform apply -auto-approve $(Pipeline.Workspace)/terraform-plan/tfpla
 
      displayName: Terraform Apply
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

# =========================
# Stage 3: Destroy
# =========================
- stage: Destroy
  displayName: Terraform Destroy
  dependsOn: InitAndPlan
  condition: and(succeeded(), eq('${{ parameters.action }}', 'destroy'))
  jobs:
  - job: terraform_destroy
    variables:
    - group: aws-credentials
    steps:

    - script: |
        cd terraform
        terraform init -reconfigure
      displayName: Terraform Init (Destroy)
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

    - script: |
        cd terraform
        terraform destroy -var-file=$(tfvarsFile) -auto-approve
      displayName: Terraform Destroy
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)
